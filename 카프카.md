## 카프카 
### 카프카 Offset
특정 메세지가 특정 파티션에서 어디에 위치하는지를 나타내는 지표. 
#### 오프셋의 특징
1. 고유성: 각 메세지는 해당 파티션 낸에서 유일한 offset을 가지며, 이는 파티션 내에서 메세지의 순서를 나타낸다.
2. 커밋: 컨슈머가 메세지를 처리한 후, 커밋을 통해 마지막으로 읽은 offset을 저장한다. offset은 컨슈머 그룹의 진행 상태를 추적하는데 사용된다. 컨슈머가 재시작되거나 장애가 발생하면 커밋된 offset을 기준으로 처리 상태를 복원한다.
3. 상태 관리: 여러 컨슈머 그룹이 독립적으로 offset을 관리한다. 동일한 파티션의 메세지를 여러 그룹이 별도로 처리할 수 있다.
4. offset 저장소: 카프카는 내부적으로 `__consumer_offsets`에 오프셋 정보를 저장한다. 이 토픽은 컨슈머 그룹의 오프셋 상태를 유지하며, 컨슈머가 커밋한 오프셋을 기록한다.
5. 복구와 리플레이: 저장된 offset을 통해 메세지를 복구하거나 리플레이 할 수 있다.
#### 오프셋 관리
1. 자동 오프셋 커밋: 카프카가 주기적으로 오프셋을 커밋한다. 메세지 처리 중 오류가 발생하거나 consumer가 비정상 종료되면 일부 메세지가 중복처리 되거나 손실될 수 있다.
   ```
   enable.auto.commit = true
   auto.commit.interval.ms = 커밋 주기
   ```  
2. 수동 오프셋 커밋: 메세지를 성공적으로 커밋한 후 명시적으로 오프셋을 커밋한다. (코드에서 직접 관리)
   ```
   commitSync(): 동기식으로 오프셋을 커밋한다. 커밋이 완료될 때까지 멈춘다.
   commitAync(): 비동기식으로 오프셋을 커밋한다. 커밋 요청을 보내고 응답을 기다리지 않는다. 
   ``` 
3. 오프셋 리셋: 스트림의 처음 위치로 돌아가려고 할 때 사용한다.
   - 콘솔 커멘트로 리셋하기: Kafka의 kafka-consumer-groups.sh 스크립트를 사용
   ```
   kafka-consumer-groups.sh --bootstrap-server -localhost:9002 --group my-group --topic my-topic --reset-offsets --to-earliest --execute
   ```
   - 프로그램 적으로 리셋하기: seekToBeginning() 또는 seekToEnd()
   ```
   consumer.seekToBeginning(consumer.assignment());
   consumer.seekToEnd(consumer.assignment());
   ```
4. 커스텀 오프셋 관리
   - 서비스에서 직접 오프셋을 수동으로 조정하거나, 외부 데이터베이스에 오프셋 정보를 저장하고 관리할 수 있다.
   - 외부 데이터베이스의 오프셋 정보를 읽어와 직접 consumer에 오프셋을 지정한다. (seek 메소드 사용)
### 카프카 파티션 
대량 데이터를 효율적으로 처리하고, 저장하기 위해 로그를 여러개의 파티션으로 나누다. 각각의 파티션은 로그의 순서가 보장된다. 
#### 파티션의 특징 
1. 데이터 분산: 파티션을 사용하면, 메세지를 여러 서버에 분산 저장할 수 있다. 데이터 병목 현상을 줄일 수 있다.
2. 병렬 처리: 각 파티션은 독립적으로 읽고 쓴다. 카프카 클러스터의 여러 브로커에서 동시에 데이터 처리가 가능해진다.
3. 순서 보장: 같은 파티션에 기록된 메세지는 삽입된 순서대로 유지된다.
4. 내결함성: 파티션은 데이터 복제를 통해 내결함성을 보존한다. 각 파티션은 하나 이상의 복제본을 가지기 때문에 브로커 중 하나가 실패하더라도 데이터가 손실되지 않는다.
5. 스케일링: 파티션 수를 조절해 클러스터의 성능과 용량을 조절할 수 있다.
#### 파티션 추가하기
1. 명령어로 파티션 추가하기
   ```
   kafka-topics.sh --bootstrap-server <BROKER_LIST> --alter --topic <TOPIC_NAME> --partitions <NEW_PARTITION_COUNT>
   ```
2. 추가된 파티션 확인하기
   ```
   kafka-topics.sh --bootstrap-server <BROKER_LIST> --describe --topic <TOPIC_NAME>
   ```    
#### 파티션 줄이기 
카프카에서 파티션을 줄이는 것은 직접적으로 지원되지 않는다. 파티션을 줄이려면 새로운 토픽을 생성해야 한다. 
1. 새로운 토픽 만들기
2. 데이터를 복사하기
3. 기존 토픽 삭제하기
4. 새로운 토픽으로 consumer를 변경하기 
